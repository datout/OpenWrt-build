name: 'My Composite Action'
description: 'Combines multiple steps to update firmware online'
runs:
  using: "composite"
  steps:
    - name: 娓呯悊鏃у浐浠?
      shell: bash
      run: |
        cd ${GITHUB_WORKSPACE}
        if [[ -f "del_assets" ]]; then
           chmod +x "del_assets"
           source "del_assets"
           chmod -R +x "${LINSHI_COMMON}"
           source "${LINSHI_COMMON}/custom/assets.sh"
        fi

    - name: 鍙戦€乕鍦ㄧ嚎鏇存柊鍥轰欢]鑷充簯绔?
      id: yunduan
      if: ${{ env.UPDATE_FIRMWARE_ONLINE == 'true' }}
      uses: ncipollo/release-action@v1
      with:
        name: AutoUpdate
        tag: ${{ env.UPDATE_TAG }}
        token: ${{ env.REPO_TOKEN }}
        allowUpdates: true
        body: ${{ env.TONGZHI_DATE }}
        artifacts: "${{ env.BIN_PATH }}/*"

    - name: 妫€鏌ヤ簯绔浐浠朵俊鎭?
      if: ${{ steps.yunduan.outcome == 'success' && env.UPDATE_FIRMWARE_ONLINE == 'true' }}
      shell: bash
      run: |
        cd ${GITHUB_WORKSPACE}
        sleep 2
        echo "YUNDUAN_API=false" >> $GITHUB_ENV
        mkdir -p $GITHUB_WORKSPACE/API
        cd $GITHUB_WORKSPACE/API
        if ! curl -s -H "Authorization: Bearer ${{ env.REPO_TOKEN }}" "https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ env.UPDATE_TAG }}" -o zzz_api; then
            wget -O zzz_api https://api.github.com/repos/${{ github.repository }}/releases/tags/${{ env.UPDATE_TAG }}
        fi
        if grep -q "${{ env.FIRMWARE_VERSION }}" zzz_api; then
           echo "AUTO_API=$GITHUB_WORKSPACE/API/zzz_api" >> $GITHUB_ENV
           echo "YUNDUAN_API=true" >> $GITHUB_ENV
        else
           echo "鑾峰彇api澶辫触,鍦ㄧ嚎鏇存柊灏嗕笉鑳借幏鍙栧埌鏈€鏂扮増鏈俊鎭?
        fi
        sleep 2

    - name: 鍙戦€乕鍦ㄧ嚎鏇存柊鍥轰欢]鑷充簯绔?
      if: ${{ env.YUNDUAN_API == 'true' }}
      uses: ncipollo/release-action@v1
      with:
        name: AutoUpdate-${{ env.TARGET_BOARD }}
        tag: ${{ env.UPDATE_TAG }}
        token: ${{ env.REPO_TOKEN }}
        artifacts: ${{ env.AUTO_API }}
        allowUpdates: true
        replacesArtifacts: true
        body: ${{ env.TONGZHI_DATE }}

    - name: 鍙戦€乕鍦ㄧ嚎鏇存柊鍥轰欢]鑷充簯绔?
      if: ${{ steps.yunduan.outcome == 'success' && env.UPDATE_FIRMWARE_ONLINE == 'true' }}
      shell: bash
      run: |
        cd ${GITHUB_WORKSPACE}
        if [[ "${YUNDUAN_API}" == "false" ]]; then
           echo "YUNDUAN_MESSAGE=銆佷簯绔俊鎭幏鍙栧け璐?鍦ㄧ嚎鏇存柊灏嗕笉鑳借幏鍙栨渶鏂颁俊鎭?涓嶈繃鍥轰欢鍙戦€佷簯绔垯鎴愬姛" >> $GITHUB_ENV
        else
           echo "YUNDUAN_MESSAGE=銆佸彂閫佷簯绔浐浠? >> $GITHUB_ENV
        fi

branding:
  icon: "terminal"
  color: "gray-dark"
