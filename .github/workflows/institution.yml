#
# åœ¨[build]æ–‡ä»¶å¤¹é‡Œé¢åˆ›å»ºæ–‡ä»¶å¤¹ç¨‹åº,è¯·å‹¿ä¿®æ”¹æ–‡ä»¶åç§°ï¼ˆinstitution.ymlï¼?
#
# åˆ›å»ºæ–‡ä»¶å¤¹éœ€è¦ç”¨åˆ°REPO_TOKENå¯†åŒ™
#
# REPO_TOKENå¯†åŒ™åˆ¶ä½œæ•™ç¨‹ï¼šhttps://git.io/jm.md
#

name: åˆ›å»ºæ–‡ä»¶å¤?
on:
  workflow_dispatch:
    inputs:
      establish_sample:
        description: 'è¯·é€‰æ‹©åˆ›å»ºæ–‡ä»¶å¤¹çš„æºç '
        required: false
        default: 'Lede'
        type: choice
        options:
          - 'Lede'
          - 'Immortalwrt'
          - 'Lienol'
          - 'Official'
          - 'Xwrt'
          - 'Mt798x'
      establish_name:
        description: 'è¾“å…¥æ‚¨éœ€è¦åˆ›å»ºçš„æ–‡ä»¶å¤¹åç§?
        required: true
        default: ''
env:
  REPO_TOKEN: ${{ secrets.REPO_TOKEN }}
  GIT_REPOSITORY: ${{github.repository}}
  TONGBU_CANGKU: 1
  TZ: Asia/Shanghai

jobs:
  build:
    name: åœ¨[build]æ–‡ä»¶å¤¹é‡Œé¢åˆ›å»ºæ–‡ä»¶å¤¹
    runs-on: ubuntu-22.04
    if: ${{ github.event.repository.owner.id }} == ${{ github.event.sender.id }}
    
    steps:
    - name: å‡†å¤‡ç»“æŸ
      uses: actions/checkout@v4
      
    - name: å¯†åŒ™æ£€æµ?
      uses: ./.github/actions/yaoshi
      
    - name: éƒ¨ç½²ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive
      run: |
        sudo -E apt-get -qq update -y
        sudo -E apt-get -qq install -y gawk git gettext libssl-dev xsltproc zip git-core wget curl grep python2.7 python3 python3-pip libpython3-dev snapd
        sudo snap install jq
        sudo timedatectl set-timezone "$TZ"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        git config --global user.name "github-actions[bot]"
        
    - name: åˆ›å»ºæ–‡ä»¶å¤?
      if: env.REPO_TOKEN
      run: |
        cd $GITHUB_WORKSPACE
        git clone -b main https://github.com/281677160/build-actions shangyou
        git clone -b main https://user:${REPO_TOKEN}@github.com/${{github.repository}} repogx
        if [[ -d "repogx/build/${{ inputs.establish_name }}" ]]; then
          echo "${{ inputs.establish_name }}å·²å­˜åœ¨ï¼Œæ— æ³•ç»§ç»­åˆ›å»º"
          exit 1
        else
          cp -Rf shangyou/build/${{ inputs.establish_sample }} repogx/build/${{ inputs.establish_name }}
          cp -Rf .github/workflows/${{ inputs.establish_sample }}.yml repogx/.github/workflows/${{ inputs.establish_name }}.yml
          export X="repogx/.github/workflows/${{ inputs.establish_name }}.yml"
          export FOLDER_NE1="target: \\[.*\\]"
          export FOLDER_NE2="target: \\[${{ inputs.establish_name }}\\]"
          sed -i "s?${FOLDER_NE1}?${FOLDER_NE2}?g" "${X}"
          export yml_name1="$(grep 'name:' "${X}" |sed 's/^[ ]*//g' |grep -v '^#\|^-' |awk 'NR==1')"
          if [[ -n "$(echo "${{ inputs.establish_name }}" |grep -i "${{ inputs.establish_sample }}")" ]]; then
            sample_name="${{ inputs.establish_name }}"
          else
            sample_name="${{ inputs.establish_sample }}_${{ inputs.establish_name }}"
          fi
          export yml_name2="name: ${sample_name}"
          sed -i "s?${yml_name1}?${yml_name2}?g" "${X}"
        fi
        cd ${GITHUB_WORKSPACE}/repogx
        git add .
        git commit -m "Update $(date +%Y-%m%d-%H%M%S)"
        git push --quiet "https://${{ secrets.REPO_TOKEN }}@github.com/${{github.repository}}" HEAD:main
        if [[ $? -ne 0 ]]; then
          echo "${{ inputs.establish_name }}æ–‡ä»¶å¤¹åˆ›å»ºå¤±è´?
        else
          echo "${{ inputs.establish_name }}æ–‡ä»¶å¤¹åˆ›å»ºå®Œæˆ?
        fi
